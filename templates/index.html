<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<title>Redis 监视器</title>
<link rel='stylesheet' type='text/css' href='/static/flatstrap.css'>
<script src='/static/jquery.js'></script>
<style>
input {
    min-width: 400px;
    padding: 0.5em;
}

th {
    padding: 4px;
}

.master {color: #044}
.slave {color: #440}

.err {color: red}
.ok {color: green}

.cluster-ceiling {
    border-top: 1px solid;
}

.cluster-footer {
    height: 16px;
}

.cluster-filling {
    width: 4px;
    height: 4px;
    background-color: navy;
}

.selected {
    background-color: #fc8;
}

.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    filter: alpha(opacity=50);
    -moz-opacity:0.5;
    -khtml-opacity: 0.5;
    opacity: 0.5;
}

.overlay-panel {
    position: fixed;
    top: 10%;
    left: 10%;
    width: 80%;
    height: 80%;
    background-color: white;
    overflow: scroll;
}
</style>
</head>
<body>

<h1>Cluster Information</h1>
<table style='text-align: center'>
    <thead>
        <tr>
            <th>
                .
            </th>
            <th>
                Node ID
            </th>
            <th>
                Host:Port
            </th>
            <th>
                Role
            </th>
            <th class='master'>
                Number of slots hold (if master)
            </th>
            <th class='slave'>
                Master ID (if slave)
            </th>
        </tr>
    </thead>
    <tbody>
        {% for cluster in clusters.itervalues() if cluster.nodes %}
        <tr>
            <td rowspan='{{ cluster.nodes|length + 1 }}' class='cluster-filling'></td>
            <td colspan='5' class='cluster-ceiling'></td>
        </tr>
            {% for node in cluster.nodes %}
            <tr {% if node.detail %}id='node-c-{{ node.node_id|e }}'{% endif %}>
                <td>
                    {{ node.node_id|e }}
                </td>
                <td>
                    <a href='#node-i-{{ node.host|e }}-{{ node.port }}'>
                        {{ node.host|e }}:{{ node.port }}
                    </a>
                </td>
                {% if node.detail.slave %}
                <td class='slave'>
                    Slave
                </td>
                <td class='slave'>-</td>
                <td class='slave'>
                    <a href='#node-c-{{ node.detail.master_id|e }}'>{{ node.detail.master_id|e }}</a>
                </td>
                {% else %}
                <td class='master'>
                    Master
                </td>
                <td class='master'>
                    {% if node.detail %}
                    {{ node.detail.slots|length }}
                    {% else %}
                    AWAITING FOR INFO POLLING
                    {% endif %}
                </td>
                <td class='master'>-</td>
                {% endif %}
            </tr>
            {% endfor %}
        <tr class='cluster-footer'></tr>
        {% endfor %}
    </tbody>
</table>

<hr>

<h1>Nodes Information</h1>
<table style='text-align: center'>
    <thead>
        <tr>
            <th>
                Host:Port
            </th>
            <th>
                Status
            </th>
            <th>
                Max memory
            </th>
            <th style='min-width: 120px'>
                Memory usage
            </th>
            <th style='min-width: 100px'>
                CPU usage
            </th>
            <th style='max-width: 120px; width: 120px'>
                Node ID
            </th>
            <th>
                Role
            </th>
            <th class='master'>
                Number of slots hold
                <br>
                (if master)
            </th>
            <th class='slave'>
                Master ID
                <br>
                (if slave)
            </th>
            <th>
                Operations
            </th>
        </tr>
    </thead>
    <tbody>
        {% for node in nodes %}
        <tr id='node-i-{{ node.host|e }}-{{ node.port }}'>
            <td>
                {% if node.cluster_id is none or not node.detail %}
                    {{ node.host|e }}:{{ node.port }}
                {% else %}
                    <a href='#node-c-{{ node.node_id|e }}'>{{ node.host|e }}:{{ node.port }}</a>
                {% endif %}
            </td>
            {% if node.stat and not node.detail %}
                <td class='slave' colspan='8'>AWAITING FOR INFO POLLING</td>
                <td>
                    <button class='btn btn-danger deleter' data-host='{{ node.host|e }}' data-port='{{ node.port }}'>DELETE</button>
                </td>
                {% continue %}
            {% endif %}

            {% if node.stat %}
            <td class='ok'>
                {% if node.cluster_id is none %}
                    stand-by
                {% else %}
                    serving
                {% endif %}
            </td>
            <td>
                {{ node.max_mem|filesizeformat }}
                <br>
                <sup>({{ node.max_mem }})</sup>
            </td>
            {% set mem_rate = node.detail.mem.used_memory_rss * 100.0 / node.max_mem %}
            <td >
                Used: {{ node.detail.mem.used_memory_human }}
                <br>
                RSS: {{ node.detail.mem.used_memory_rss|filesizeformat }}
                <br>
                <span class='{% if mem_rate > 90 %}err{% else %}ok{% endif %}'>
                RSS/Max: {{ mem_rate|round(2) }}%
                </span>
            </td>
            <td>
                User {{ node.detail.cpu.used_cpu_user }}
                <br>
                Sys {{ node.detail.cpu.used_cpu_sys }}
            </td>
            <td>
                {{ node.node_id[:8]|e + '...' }}
            </td>
            </td>
                {% if node.detail.slave %}
                <td class='slave'>
                    Slave
                </td>
                <td class='slave'>-</td>
                <td class='slave'>
                    <a href='#node-c-{{ node.detail.master_id|e }}'>{{ node.detail.master_id[:8]|e + '...' }}</a>
                </td>
                {% else %}
                <td class='master'>
                    Master
                </td>
                <td class='master'>{{ node.detail.slots|length }}</td>
                <td class='master'>-</td>
                {% endif %}
            {% else %}
            <td class='err'>E</td>
            <td class='err'>-</td>
            <td class='err'>-</td>
            <td class='err'>-</td>
            <td class='err'>-</td>
            <td class='err'>-</td>
            <td class='err'>-</td>
            <td class='err'>-</td>
            {% endif %}
            <td>
            <a class='btn btn-primary' data-host='{{ node.host|e }}' data-port='{{ node.port }}' onclick='launchClusterPanel({{ node|tojson }})'>Cluster Panel</a>
            {% if node.cluster_id is none %}
                <button class='btn btn-danger deleter' data-host='{{ node.host|e }}' data-port='{{ node.port }}'>DELETE</button>
            {% endif %}

            {% if not node.stat %}
                <button class='btn btn-primary fix-marker' data-host='{{ node.host|e }}' data-port='{{ node.port }}'>Retry Connect</button>
            {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function selectHash() {
    $(document.getElementById(window.location.hash.slice(1))).addClass('selected');
}
$(window).on('hashchange', function() {
    $('.selected').removeClass('selected');
    selectHash();
});
if (window.location.hash) {
    selectHash();
}

$('.deleter').click(function() {
    var btn = $(this);
    $.post('/nodes/del', {
        host: btn.data('host'),
        port: btn.data('port')
    }, function() {
        btn.parent().html('NODE DELETED');
    });
});

$('.fix-marker').click(function() {
    var btn = $(this);
    $.post('/nodes/fix', {
        host: btn.data('host'),
        port: btn.data('port')
    }, function() {
        window.location.reload();
    });
});
</script>

<hr>

<h1>Add Redis Nodes</h1>
<table>
    <tr>
        <td>
            Host
        </td>
        <td>
            <input id='add-nodes-host'>
        </td>
    </tr>
    <tr>
        <td>
            Port (range)
            <br>
            <sup>e.g. 6370 / 6000-6020</sup>
        </td>
        <td>
            <input id='add-nodes-port'>
        </td>
    </tr>
    <tr>
        <td>
            Max Memory (byte)
            <br>
            <sup>Could be like 1024 / 16M / 1G</sup>
        </td>
        <td>
            <input id='add-nodes-mem'>
            =
            <span id='add-nodes-mem-parsed'>0</span>
        </td>
    </tr>
</table>
<button id='add-nodes'>Add</button><span id='add-nodes-error'></span>

<script>
var errorSpan = $('#add-nodes-error');
var parsedMem = $('#add-nodes-mem-parsed');

$('#add-nodes-mem').blur(function() {
    errorSpan.text('');

    var mem = $('#add-nodes-mem').val();
    var base = parseFloat(mem);
    if (isNaN(base)) {
        parsedMem.text('-').mem = NaN;
        return errorSpan.text('Invalid memory format');
    }
    var factor = 1;
    switch (mem[mem.length - 1]) {
        case 'k':
        case 'K':
            factor = 1024;
            break;
        case 'm':
        case 'M':
            factor = 1024 * 1024;
            break;
        case 'g':
        case 'G':
            factor = 1024 * 1024 * 1024;
            break;
        default:
    }
    base *= factor;
    parsedMem.text(base);
    if (base % 1 != 0) {
        parsedMem.mem = NaN;
        return errorSpan.text('Memory is not an integer');
    }
    parsedMem.mem = base;
});

$('#add-nodes').click(function() {
    if (isNaN(parsedMem.mem)) {
        return $('#add-nodes-mem').focus();
    }

    if ($('#add-nodes-host').val().length == 0) {
        return $('#add-nodes-host').focus();
    }

    errorSpan.text('');
    var portBegin = NaN, portEnd = 0;
    var portRange = $('#add-nodes-port').val().split('-');
    if (portRange.length === 1) {
        portBegin = parseInt(portRange[0]);
        portEnd = portBegin + 1;
    } else if (portRange.length === 2) {
        portBegin = parseInt(portRange[0]);
        portEnd = parseInt(portRange[1]) + 1;
    }
    if (isNaN(portBegin) || isNaN(portEnd)) {
        $('#add-nodes-port').focus();
        return errorSpan.text('Invalid port format');
    }

    -function addNode(host, portBegin, portEnd, memory) {
        if (portBegin == portEnd) {
            return window.location.reload();
        }
        $.post('/nodes/add', {
            host: host,
            port: portBegin,
            mem: memory
        }, function() {
            addNode(host, portBegin + 1, portEnd, memory);
        });
        errorSpan.text('Adding :' + portBegin + '...');
    }($('#add-nodes-host').val(), portBegin, portEnd, parsedMem.mem);
});
</script>

<div id='node-cluster-panel' style='display: none'>
    <h1 style='float: left; margin-left: 6px'>Cluster Operations</h1>
    <div style='float: right'><button id='node-cluster-quit' class='btn btn-danger'>X</button></div>
    <hr style='clear: both'>
    <h1 style='margin-left: 1em'>
        <span id='ncp-node-host'></span>
        :
        <span id='ncp-node-port'></span>
        -
        <span id='ncp-node-id'></span>
    </h1>
    Status: <span id='ncp-status'></span>
    <ul>
        <li>Connected clients: <span id='ncp-stats-conn-clients'></span></li>
        <li>Expired keys: <span id='ncp-stats-expired-keys'></span></li>
        <li>Evicted keys: <span id='ncp-stats-evicted-keys'></span></li>
        <li>Keyspace hits: <span id='ncp-stats-ks-hits'></span></li>
        <li>Keyspace misses: <span id='ncp-stats-ks-misses'></span></li>
        <li>AOF enabled: <span id='ncp-stats-aof-enabled'></span></li>
    </ul>

    <hr>

    <div id='ncp-serving'>
        <table>
            <caption>Serving in cluster</caption>
            <tr>
                <th>Cluster ID</th>
                <td id='ncp-cluster-id'></td>
            </tr>
            <tr>
                <th>Number of slots</th>
                <td id='ncp-slots'></td>
            </tr>
        </table>
        <div>
            <button class='btn toggle-next'>Quit cluster</button>
            <button class='btn btn-primary' id='ncp-quit-cluster'>CONFIRM</button>
        </div>
    </div>

    <div id='ncp-stand-by'>
        <div>
            <button class='btn toggle-next'>Launch as a cluster</button>
            <span>
                Cluster description: <input id='ncp-cluster-descr'>
                <button class='btn btn-primary' id='ncp-launch-as-cluster'>Launch</button>
            </span>
        </div>
        <div>
            <button class='btn toggle-next'>Join a cluster</button>
            <span>
                <select id='ncp-select-cluster'></select>
                <button class='btn btn-primary' id='ncp-join-cluster'>Join as a MASTER</button>
                -- OR --
                <select id='ncp-select-master'></select>
                <button class='btn btn-primary' id='ncp-replicate'>Replicate as a SLAVE</button>
            <span>
        </div>
    </div>
</div>

<script>
var NODES = {{ nodes|tojson }};
var CLUSTERS = {{ clusters|tojson }};

function createOverlapPanel() {
    var bg = jQuery('<div>').addClass('overlay');
    var panel = jQuery('<div>').addClass('overlay-panel');
    jQuery(document.body).append(bg).append(panel);
    panel.quit = function() {
        bg.remove();
        panel.remove();
    }
    return panel;
}

function launchClusterPanel(node) {
    var panel = $('#node-cluster-panel').detach();
    var ovl = createOverlapPanel();
    ovl.append(panel.show());
    $('#node-cluster-quit').unbind('click').click(function() {
        panel.detach();
        $(document.body).append(panel.hide());
        ovl.quit();
    });
    $('.toggle-next').next().hide();

    $('#ncp-node-host').text(node.host);
    $('#ncp-node-port').text(node.port);
    $('#ncp-stats-conn-clients').text(node.detail.conn.connected_clients);
    $('#ncp-stats-expired-keys').text(node.detail.storage.expired_keys);
    $('#ncp-stats-evicted-keys').text(node.detail.storage.evicted_keys);
    $('#ncp-stats-ks-hits').text(node.detail.storage.keyspace_hits);
    $('#ncp-stats-ks-misses').text(node.detail.storage.keyspace_misses);
    $('#ncp-stats-aof-enabled').text(node.detail.storage.aof_enabled);
    $('#ncp-node-id').text(node.node_id ? node.node_id : '<NO NODE ID>');
    $('#ncp-status').removeClass('ok err').text(node.stat ? 'OK' : 'Error').addClass(node.stat ? 'ok' : 'err');

    if (node.cluster_id) {
        showServingPanel(node);
    } else {
        showStandbyPanel(node);
    }
}

function showServingPanel(node) {
    $('#ncp-stand-by').hide();
    $('#ncp-serving').show();

    $('#ncp-quit-cluster').data({host: node.host, port: node.port, cluster_id: node.cluster_id});
    $('#ncp-cluster-id').text(node.cluster_id);
    $('#ncp-slots').text(node.detail.slots ? node.detail.slots.length : '-');
}

function showStandbyPanel(node) {
    $('#ncp-stand-by').show();
    $('#ncp-serving').hide();
    $('#ncp-select-cluster').html('').append($('<option>').text('Select cluster'));
    for (var id in CLUSTERS) {
        var cluster = CLUSTERS[id];
        if (cluster.nodes.length == 0) {
            continue;
        }
        $('#ncp-select-cluster').append($('<option>').text([cluster.descr, '-', cluster.nodes.length, 'nodes'].join(' ')).val(id));
    }
    $('#ncp-launch-as-cluster').data({host: node.host, port: node.port});
    $('#ncp-join-cluster').data({host: node.host, port: node.port});
    $('#ncp-replicate').data({host: node.host, port: node.port});

    $('#ncp-cluster-id').text(node.cluster_id);
    $('#ncp-slots').text(node.detail.slots ? node.detail.slots.length : '-');
}

$('#ncp-select-cluster').change(function() {
    var cluster = CLUSTERS[$(this).val()];
    $('#ncp-select-master').html('');
    if (!cluster) {
        return;
    }
    $('#ncp-select-master').html('').append(cluster.nodes.map(function(e) {
        if (e.slave) {
            return '';
        }
        return $('<option>').text([e.host, ':', e.port, ' - ', e.node_id].join('')).data({host: e.host, port: e.port});
    }));
});

$('#ncp-quit-cluster').click(function() {
    var btn = $(this);
    btn.attr('disabled', 'disabled').text('Please wait');
    $.ajax({
        url: '/cluster/quit',
        type: 'POST',
        data: {
            host: btn.data('host'),
            port: btn.data('port'),
            cluster_id: btn.data('cluster_id')
        },
        success: function() {
            window.location.reload();
        },
        error: function(r) {
            btn.parent().text('FAILED: ' + r.responseText);
        }
    });
});

$('#ncp-launch-as-cluster').click(function() {
    if ($('#ncp-cluster-descr').val().length === 0) {
        return $('#ncp-cluster-descr').focus();
    }
    var btn = $(this);
    btn.text('Please wait');
    $('#ncp-stand-by button').attr('disabled', 'disabled');
    $.post('/cluster/add', {
        descr: $('#ncp-cluster-descr').val()
    }, function(r) {
        $.ajax({
            url: '/cluster/launch',
            type: 'POST',
            data: {
                cluster_id: r,
                host: btn.data('host'),
                port: btn.data('port')
            },
            success: function() {
                window.location.reload();
            },
            error: function(r) {
                btn.parent().text('FAILED: ' + r.responseText);
            }
        });
    });
});

$('#ncp-join-cluster').click(function() {
    var btn = $(this);
    var cluster_id = parseInt($('#ncp-select-cluster').val());
    if (isNaN(cluster_id)) {
        return;
    }
    $('#ncp-stand-by button').attr('disabled', 'disabled');
    btn.text('Please wait');
    $.ajax({
        url: '/cluster/join',
        type: 'POST',
        data: {
            host: btn.data('host'),
            port: btn.data('port'),
            cluster_id: cluster_id
        },
        success: function() {
            window.location.reload();
        },
        error: function(r) {
            btn.parent().text('FAILED: ' + r.responseText);
        }
    });
});

$('#ncp-replicate').click(function() {
    var opt = $('#ncp-select-master :selected');
    if (!opt || !opt.data('host')) {
        return;
    }
    $('#ncp-stand-by button').attr('disabled', 'disabled');
    var btn = $(this);
    btn.text('Please wait');
    $.ajax({
        url: '/cluster/replicate',
        type: 'POST',
        data: {
            master_host: opt.data('host'),
            master_port: opt.data('port'),
            slave_host: btn.data('host'),
            slave_port: btn.data('port')
        },
        success: function() {
            window.location.reload();
        },
        error: function(r) {
            btn.parent().text('FAILED: ' + r.responseText);
        }
    });
});

$('.toggle-next').click(function() {$(this).next().toggle();});
</script>
